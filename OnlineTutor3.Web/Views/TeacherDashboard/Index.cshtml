@model OnlineTutor3.Web.ViewModels.TeacherDashboardViewModel
@{
    ViewData["Title"] = "–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞";
}

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2 page-header">
        <div>
            <h4 class="mb-0 d-flex align-items-center gap-2 page-header-title">
                <i class="fas fa-tachometer-alt gradient-icon-green"></i>
                <span>–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</span>
            </h4>
            <p class="text-muted-modern mb-0 small">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div id="signalr-status" class="signalr-status" style="display: none;">
                <i class="fas fa-circle text-muted-modern me-1"></i>
                <span class="text-muted-modern">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div id="signalr-activity-indicator"></div>
        </div>
    </div>

    <div class="row g-1 g-md-2 mb-3">
        <div class="col-6 col-md-3">
            <div class="card modern-card stat-card">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-card-value">@Model.TotalActiveTests</div>
                    <small class="stat-card-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card modern-card stat-card">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-value" id="stats-in-progress">@Model.TotalStudentsInProgress</div>
                    <small class="stat-card-label">–ü—Ä–æ—Ö–æ–¥—è—Ç —Å–µ–π—á–∞—Å</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card modern-card stat-card">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-value" id="stats-completed-today">@Model.TotalCompletedToday</div>
                    <small class="stat-card-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card modern-card stat-card">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="stat-card-value" id="stats-notifications">0</div>
                    <small class="stat-card-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</small>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link nav-link-modern active" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                <i class="fas fa-stream nav-link-icon"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link nav-link-modern" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
                <i class="fas fa-list nav-link-icon"></i> –¢–µ—Å—Ç—ã
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="activity" role="tabpanel">
            <div class="card shadow-sm border-0 mb-3 search-filter-card">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search nav-link-icon"></i>
                            <strong class="small text-dark-modern">–ü–æ–∏—Å–∫:</strong>
                        </div>
            
                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control form-control-sm border-start-0 form-control-modern" 
                                       id="activitySearchInput" 
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–µ—Å—Ç–∞..."
                                       onkeyup="filterActivities()">
                                <button class="btn btn-sm btn-modern-outline-secondary" 
                                        type="button" 
                                        id="clearActivitySearch"
                                        onclick="clearActivitySearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
            
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-modern-outline-primary" onclick="refreshActivity()">
                                <i class="fas fa-sync"></i>
                                <span class="d-none d-sm-inline ms-1">–û–±–Ω–æ–≤–∏—Ç—å</span>
                            </button>
                            <span class="badge badge-modern-secondary" id="activityCount">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card modern-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0" id="activityTable">
                            <thead>
                                <tr>
                                    <th>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</th>
                                    <th class="text-center d-none d-md-table-cell">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                                    <th class="text-center">–û—Ü–µ–Ω–∫–∞</th>
                                    <th class="text-center d-none d-md-table-cell">–í—Ä–µ–º—è</th>
                                    <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="activity-feed">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                        <p class="text-muted-modern mt-2 mb-0 small">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="noActivityResults" class="empty-state-large" style="display: none;">
                        <i class="fas fa-search empty-state-icon"></i>
                        <h5 class="empty-state-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h5>
                        <p class="empty-state-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                        <button class="btn btn-modern-outline-primary btn-sm" onclick="clearActivitySearch()">
                            <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tests" role="tabpanel">
            <div class="card shadow-sm border-0 mb-3 search-filter-card">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search nav-link-icon"></i>
                            <strong class="small text-dark-modern">–ü–æ–∏—Å–∫:</strong>
                        </div>

                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text"
                                       class="form-control form-control-sm border-start-0 form-control-modern"
                                       id="testsSearchInput"
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–µ—Å—Ç–∞..."
                                       onkeyup="filterTests()">
                                <button class="btn btn-sm btn-modern-outline-secondary"
                                        type="button"
                                        id="clearTestsSearch"
                                        onclick="clearTestsSearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterAll" value="all" checked onchange="filterTests()">
                                <label class="btn btn-modern-outline-secondary" for="filterAll">
                                    <i class="fas fa-list me-1"></i>
                                    <span class="d-none d-sm-inline">–í—Å–µ</span>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterSpelling" value="spelling" onchange="filterTests()">
                                <label class="btn btn-modern-outline-primary" for="filterSpelling">
                                    <i class="fas fa-spell-check"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterPunctuation" value="punctuation" onchange="filterTests()">
                                <label class="btn btn-modern-outline-info" for="filterPunctuation">
                                    <i class="fas fa-quote-right"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterOrthoeopy" value="orthoeopy" onchange="filterTests()">
                                <label class="btn btn-modern-outline-success" for="filterOrthoeopy">
                                    <i class="fas fa-volume-up"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterRegular" value="regular" onchange="filterTests()">
                                <label class="btn btn-modern-outline-secondary" for="filterRegular">
                                    <i class="fas fa-clipboard-check"></i>
                                </label>
                            </div>

                            <span class="badge badge-modern-secondary" id="testsCount">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card modern-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0" id="testsTable">
                            <thead>
                                <tr>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</th>
                                    <th class="d-none d-lg-table-cell">–¢–∏–ø</th>
                                    <th class="text-center">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                                    <th class="text-center">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</th>
                                    <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                @* –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è *@
                                @foreach (var test in Model.SpellingTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="spelling"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-primary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-spell-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-primary test-type-badge">
                                                <i class="fas fa-spell-check me-1"></i>
                                                –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-success test-count-completed" data-test-id="@test.Id" data-test-type="spelling">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress" data-test-id="@test.Id" data-test-type="spelling">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="SpellingTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è *@
                                @foreach (var test in Model.PunctuationTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="punctuation"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-info test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-quote-right"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-info test-type-badge">
                                                <i class="fas fa-quote-right me-1"></i>
                                                –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-success test-count-completed" data-test-id="@test.Id" data-test-type="punctuation">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress" data-test-id="@test.Id" data-test-type="punctuation">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="PunctuationTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –û—Ä—Ñ–æ—ç–ø–∏—è *@
                                @foreach (var test in Model.OrthoeopyTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="orthoeopy"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-success test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-volume-up"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-success test-type-badge">
                                                <i class="fas fa-volume-up me-1"></i>
                                                –û—Ä—Ñ–æ—ç–ø–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-success test-count-completed" data-test-id="@test.Id" data-test-type="orthoeopy">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress" data-test-id="@test.Id" data-test-type="orthoeopy">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="OrthoeopyTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã *@
                                @foreach (var test in Model.RegularTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="regular"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-secondary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-clipboard-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-secondary test-type-badge">
                                                <i class="fas fa-clipboard-check me-1"></i>
                                                –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-success test-count-completed" data-test-id="@test.Id" data-test-type="regular">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress" data-test-id="@test.Id" data-test-type="regular">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="RegularTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @if (!Model.SpellingTests.Any() && !Model.PunctuationTests.Any() && 
                                    !Model.OrthoeopyTests.Any() && !Model.RegularTests.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="empty-state-large">
                                                <i class="fas fa-clipboard-list empty-state-icon"></i>
                                                <h5 class="empty-state-title">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</h5>
                                                <p class="empty-state-text">–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content modern-modal-content">
                <div class="modal-header modern-modal-header">
                    <h5 class="modal-title modern-modal-title" id="testResultModalTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞</h5>
                    <button type="button" class="btn-close modern-btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modern-modal-body" id="testResultModalBody">
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="~/js/teacher-dashboard-signalr.js" asp-append-version="true"></script>
    
    <script>
        var TEACHER_ID = '@Model.Teacher.Id';
        var notificationCount = 0;
        var allActivities = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Dashboard');

            document.getElementById('signalr-status').style.display = 'inline-flex';

            loadRecentActivity();

            window.dashboardSignalR = new TeacherDashboardSignalR(TEACHER_ID);
            window.dashboardSignalR.start();

            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterActivities);
            }

            updateTestsCount();
        });

        function loadRecentActivity() {
            fetch('/TeacherDashboard/GetRecentActivity')
                .then(response => response.json())
                .then(data => {
                    allActivities = data;
                    renderActivities(allActivities);
                    updateActivityCount();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
                    document.getElementById('activity-feed').innerHTML = 
                        '<tr><td colspan="5" class="text-center py-5"><div class="empty-state-small"><small class="empty-state-text text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</small></div></td></tr>';
                });
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò –° –ì–†–£–ü–ü–ò–†–û–í–ö–û–ô –ü–û –î–ù–Ø–ú =====

        function renderActivities(activities) {
            displayActivities(activities);
        }

        function displayActivities(activities) {
            var feed = document.getElementById('activity-feed');
            var noResults = document.getElementById('noActivityResults');
            
            if (!activities || activities.length === 0) {
                feed.innerHTML = 
                    '<tr><td colspan="5" class="text-center py-5">' +
                    '<div class="empty-state-small">' +
                    '<small class="empty-state-text">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</small>' +
                    '</div>' +
                    '</td></tr>';
                
                if (noResults) noResults.style.display = 'none';
                updateActivityCount(0);
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
            var groupedActivities = groupActivitiesByDate(activities);
            
            var html = '';
            var totalCount = 0;
            
            Object.keys(groupedActivities).forEach(function(dateKey, index) {
                var group = groupedActivities[dateKey];
                var isToday = index === 0; // –ü–µ—Ä–≤–∞—è –≥—Ä—É–ø–ø–∞ - —Å–µ–≥–æ–¥–Ω—è
                var isExpanded = isToday; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞—Å–∫—Ä—ã—Ç–∞ —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è
                
                html += createDateGroupHeader(group.label, group.activities.length, dateKey, isExpanded);
                
                group.activities.forEach(function(activity) {
                    html += createActivityRow(activity, dateKey, isExpanded);
                    totalCount++;
                });
            });
            
            feed.innerHTML = html;
            if (noResults) noResults.style.display = 'none';
            updateActivityCount(totalCount);
        }

        // ===== –ì–†–£–ü–ü–ò–†–û–í–ö–ê –ü–û –î–ê–¢–ê–ú =====

        function groupActivitiesByDate(activities) {
            var groups = {};
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            
            var yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            activities.forEach(function(activity) {
                var activityDate = new Date(activity.lastActivityAt);
                activityDate.setHours(0, 0, 0, 0);
                
                var dateKey;
                var label;
                
                if (activityDate.getTime() === today.getTime()) {
                    dateKey = 'today';
                    label = '–°–µ–≥–æ–¥–Ω—è';
                } else if (activityDate.getTime() === yesterday.getTime()) {
                    dateKey = 'yesterday';
                    label = '–í—á–µ—Ä–∞';
                } else {
                    dateKey = 'date_' + activityDate.getTime();
                    label = formatDate(activityDate);
                }
                
                if (!groups[dateKey]) {
                    groups[dateKey] = {
                        label: label,
                        date: activityDate,
                        activities: []
                    };
                }
                
                groups[dateKey].activities.push(activity);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            var sortedGroups = {};
            Object.keys(groups)
                .sort(function(a, b) {
                    return groups[b].date - groups[a].date;
                })
                .forEach(function(key) {
                    sortedGroups[key] = groups[key];
                });
            
            return sortedGroups;
        }

        // ===== –°–û–ó–î–ê–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–ê –ì–†–£–ü–ü–´ =====

        function createDateGroupHeader(label, count, dateKey, isExpanded) {
            var icon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';
            
            return '<tr class="date-group-header" onclick="toggleDateGroup(\'' + dateKey + '\')" style="cursor: pointer; background-color: #f8f9fa;">' +
                   '<td colspan="5" class="py-2 px-3">' +
                   '<div class="d-flex align-items-center justify-content-between">' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<i class="fas ' + icon + ' text-primary date-group-icon" id="icon-' + dateKey + '"></i>' +
                   '<strong class="text-dark-modern">' + label + '</strong>' +
                   '<span class="badge badge-modern-secondary badge-sm">' + count + '</span>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   '</tr>';
        }

        // ===== –°–û–ó–î–ê–ù–ò–ï –°–¢–†–û–ö–ò –ê–ö–¢–ò–í–ù–û–°–¢–ò =====

        function createActivityRow(activity, dateKey, isVisible) {
            var statusBadge = activity.status === 'completed' 
                ? '<span class="badge badge-modern-success">–ó–∞–≤–µ—Ä—à–µ–Ω</span>'
                : activity.status === 'started'
                ? '<span class="badge badge-modern-info">–ù–∞—á–∞—Ç</span>'
                : '<span class="badge badge-modern-warning">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>';
            
            var percentageBadge = '';
            var gradeBadge = '';

            // –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∏ –æ—Ü–µ–Ω–∫—É
            if (activity.status === 'completed' && activity.percentage !== undefined) {
                var percentColor = activity.percentage >= 80 ? 'success' : 
                                  activity.percentage >= 60 ? 'warning' : 'danger';
                percentageBadge = '<span class="badge badge-modern-' + percentColor + '">' + 
                               activity.percentage.toFixed(1) + '%</span>';

                var grade = activity.percentage >= 91 ? 5 :
                           activity.percentage >= 80 ? 4 :
                           activity.percentage >= 60 ? 3 : 2;
                var gradeColor = grade === 5 ? 'success' :
                                grade === 4 ? 'info' :
                                grade === 3 ? 'warning' : 'danger';
                gradeBadge = '<span class="badge badge-modern-' + gradeColor + '">' + grade + '</span>';
            } else {
                percentageBadge = '<span class="text-muted-modern">‚Äî</span>';
                gradeBadge = '<span class="text-muted-modern">‚Äî</span>';
            }

            var testTypeIcon = {
                'spelling': 'fa-spell-check',
                'punctuation': 'fa-quote-right',
                'orthoeopy': 'fa-volume-up',
                'regular': 'fa-clipboard-check'
            }[activity.testType] || 'fa-clipboard-list';

            var testTypeIconClass = {
                'spelling': 'nav-link-icon',
                'punctuation': 'nav-link-icon-blue',
                'orthoeopy': 'nav-link-icon-green',
                'regular': 'nav-link-icon'
            }[activity.testType] || 'nav-link-icon';

            var lastActivity = new Date(activity.lastActivityAt);
            var timeStr = lastActivity.toLocaleString('ru-RU', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            var actionButton = activity.status === 'completed' && activity.testResultId
                ? '<button class="btn btn-sm btn-modern-outline-info" onclick="showTestResult(\'' + activity.testType + '\', ' + activity.testResultId + ', \'' + activity.studentName + '\')">' +
                  '<i class="fas fa-eye"></i> <span class="d-none d-md-inline">–ü–æ–¥—Ä–æ–±–Ω–æ</span></button>'
                : '';

            var displayStyle = isVisible ? '' : 'display: none;';

            return '<tr class="activity-row date-group-' + dateKey + '" ' +
                   'data-search-text="' + (activity.studentName + ' ' + activity.testTitle).toLowerCase() + '" ' +
                   'data-date-group="' + dateKey + '" ' +
                   'style="' + displayStyle + '">' +
                   '<td>' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<i class="fas ' + testTypeIcon + ' ' + testTypeIconClass + '"></i>' +
                   '<div>' +
                   '<strong class="text-dark-modern">' + activity.studentName + '</strong> - <span class="text-dark-modern">' + activity.testTitle + '</span>' +
                   '<br><small class="text-muted-modern">' + statusBadge + '</small>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   '<td class="text-center d-none d-md-table-cell">' + percentageBadge + '</td>' +
                   '<td class="text-center">' + gradeBadge + '</td>' +
                   '<td class="text-center d-none d-md-table-cell"><small class="text-muted-modern">' + timeStr + '</small></td>' +
                   '<td class="text-center">' + actionButton + '</td>' +
                   '</tr>';
        }

        // ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ì–†–£–ü–ü–´ –î–ù–ï–ô =====

        function toggleDateGroup(dateKey) {
            var rows = document.querySelectorAll('.date-group-' + dateKey);
            var icon = document.getElementById('icon-' + dateKey);
            
            if (!rows.length || !icon) return;
            
            var isVisible = rows[0].style.display !== 'none';
            
            rows.forEach(function(row) {
                row.style.display = isVisible ? 'none' : '';
            });
            
            icon.className = isVisible ? 
                'fas fa-chevron-right text-primary date-group-icon' : 
                'fas fa-chevron-down text-primary date-group-icon';
            
            filterActivities();
        }

        // ===== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢–´ =====

        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
        }

        function filterActivities() {
            var searchInput = document.getElementById('activitySearchInput');
            if (!searchInput) return;

            var searchText = searchInput.value.toLowerCase().trim();

            var rows = document.querySelectorAll('.activity-row');
            var visibleCount = 0;
            
            var groupCounts = {};

            rows.forEach(function(row) {
                var rowSearchText = row.getAttribute('data-search-text') || '';
                var dateGroup = row.getAttribute('data-date-group');
                var groupIcon = document.getElementById('icon-' + dateGroup);
                var isGroupExpanded = groupIcon && groupIcon.classList.contains('fa-chevron-down');
                
                if (!groupCounts[dateGroup]) {
                    groupCounts[dateGroup] = { total: 0, visible: 0 };
                }
                groupCounts[dateGroup].total++;
                
                var matchesSearch = !searchText || rowSearchText.includes(searchText);
                
                if (matchesSearch && isGroupExpanded) {
                    row.style.display = '';
                    groupCounts[dateGroup].visible++;
                    visibleCount++;
                } else if (matchesSearch && !isGroupExpanded) {
                    row.style.display = 'none';
                } else {
                    row.style.display = 'none';
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –≥—Ä—É–ø–ø
            Object.keys(groupCounts).forEach(function(dateGroup) {
                var header = document.querySelector('.date-group-header [id^="icon-' + dateGroup + '"]');
                if (header) {
                    var badge = header.parentElement.parentElement.querySelector('.badge');
                    if (badge) {
                        var count = groupCounts[dateGroup];
                        if (searchText && count.visible !== count.total) {
                            badge.textContent = count.visible + ' / ' + count.total;
                            badge.classList.remove('badge-modern-secondary');
                            badge.classList.add('badge-modern-primary');
                        } else {
                            badge.textContent = count.total;
                            badge.classList.remove('badge-modern-primary');
                            badge.classList.add('badge-modern-secondary');
                        }
                    }
                }
            });

            var noResults = document.getElementById('noActivityResults');
            var tableBody = document.getElementById('activity-feed');
            
            if (visibleCount === 0 && searchText) {
                if (tableBody) tableBody.style.display = 'none';
                if (noResults) noResults.style.display = 'block';
            } else {
                if (tableBody) tableBody.style.display = '';
                if (noResults) noResults.style.display = 'none';
            }

            updateActivityCount(visibleCount);
            
            var clearButton = document.getElementById('clearActivitySearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }
        }

        function clearActivitySearch() {
            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterActivities();
            }
        }

        function refreshActivity() {
            loadRecentActivity();
        }

        function updateActivityCount(count) {
            var countElement = document.getElementById('activityCount');
            if (countElement) {
                var total = document.querySelectorAll('.activity-row').length;
                if (count !== undefined) {
                    countElement.textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ: ' + count + (count !== total ? ' –∏–∑ ' + total : '');
                } else {
                    countElement.textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ: ' + total;
                }
            }
        }

        function filterTests() {
            var searchInput = document.getElementById('testsSearchInput');
            var searchText = searchInput ? searchInput.value.toLowerCase() : '';
            var selectedType = document.querySelector('input[name="testTypeFilter"]:checked')?.value || 'all';
            var rows = document.querySelectorAll('#testsTableBody .test-row');
            var visibleCount = 0;

            rows.forEach(function(row) {
                var rowType = row.getAttribute('data-test-type') || '';
                var rowText = row.getAttribute('data-search-text') || '';
                
                var typeMatch = selectedType === 'all' || rowType === selectedType;
                var textMatch = rowText.includes(searchText);
                
                if (typeMatch && textMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateTestsCount(visibleCount);
            
            var clearButton = document.getElementById('clearTestsSearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }
        }

        function clearTestsSearch() {
            var searchInput = document.getElementById('testsSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterTests();
            }
        }

        function updateTestsCount(count) {
            var countElement = document.getElementById('testsCount');
            if (countElement) {
                var total = count !== undefined ? count : document.querySelectorAll('#testsTableBody .test-row').length;
                countElement.textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ: ' + total;
            }
        }

        function showTestResult(testType, testResultId, studentName) {
            window.showTestResultModal(testType, testResultId, studentName);
        }

        function prependActivity(activity) {
            allActivities.unshift(activity);
            if (allActivities.length > 100) {
                allActivities = allActivities.slice(0, 100);
            }
            displayActivities(allActivities);
            updateActivityCount();
        }

        function updateStats(action) {
            if (action === 'completed') {
                var completedToday = document.getElementById('stats-completed-today');
                if (completedToday) {
                    var count = parseInt(completedToday.textContent) || 0;
                    completedToday.textContent = count + 1;
                }
            } else if (action === 'started') {
                var inProgress = document.getElementById('stats-in-progress');
                if (inProgress) {
                    var count = parseInt(inProgress.textContent) || 0;
                    inProgress.textContent = count + 1;
                }
            }
        }
    </script>
}

