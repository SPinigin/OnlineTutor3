@model OnlineTutor3.Web.ViewModels.TeacherDashboardViewModel
@{
    ViewData["Title"] = "–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞";
}

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-tachometer-alt text-primary me-2"></i>
                –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            </h2>
            <p class="text-muted mb-0">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div id="signalr-status" class="signalr-status" style="display: none;">
                <i class="fas fa-circle text-secondary me-1"></i>
                <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div id="signalr-activity-indicator"></div>
        </div>
    </div>

    <div class="row g-2 g-md-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-clipboard-list text-primary stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0">@Model.TotalActiveTests</h3>
                    <small class="text-muted stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-clock text-warning stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-in-progress">@Model.TotalStudentsInProgress</h3>
                    <small class="text-muted stat-label">–ü—Ä–æ—Ö–æ–¥—è—Ç —Å–µ–π—á–∞—Å</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-check-circle text-success stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-completed-today">@Model.TotalCompletedToday</h3>
                    <small class="text-muted stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card border-0 shadow-sm stat-card-compact">
                <div class="card-body text-center p-2 p-md-3">
                    <i class="fas fa-bell text-info stat-icon mb-1 mb-md-2"></i>
                    <h3 class="stat-number mb-0" id="stats-notifications">0</h3>
                    <small class="text-muted stat-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</small>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                <i class="fas fa-stream"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
                <i class="fas fa-list"></i> –¢–µ—Å—Ç—ã
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="activity" role="tabpanel">
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search text-primary"></i>
                            <strong class="small">–ü–æ–∏—Å–∫:</strong>
                        </div>
            
                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="activitySearchInput" 
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–µ—Å—Ç–∞..."
                                       onkeyup="filterActivities()">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        id="clearActivitySearch"
                                        onclick="clearActivitySearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
            
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                                <i class="fas fa-sync"></i>
                                <span class="d-none d-sm-inline ms-1">–û–±–Ω–æ–≤–∏—Ç—å</span>
                            </button>
                            <span class="badge bg-secondary" id="activityCount">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-compact mb-0" id="activityTable">
                            <thead class="table-light">
                                <tr>
                                    <th>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</th>
                                    <th class="text-center d-none d-md-table-cell">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                                    <th class="text-center">–û—Ü–µ–Ω–∫–∞</th>
                                    <th class="text-center d-none d-md-table-cell">–í—Ä–µ–º—è</th>
                                    <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="activity-feed">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0 small">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="noActivityResults" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                        <h5 class="text-muted mb-2">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h5>
                        <p class="text-muted mb-3">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="clearActivitySearch()">
                            <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tests" role="tabpanel">
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search text-primary"></i>
                            <strong class="small">–ü–æ–∏—Å–∫:</strong>
                        </div>

                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text"
                                       class="form-control"
                                       id="testsSearchInput"
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–µ—Å—Ç–∞..."
                                       onkeyup="filterTests()">
                                <button class="btn btn-outline-secondary"
                                        type="button"
                                        id="clearTestsSearch"
                                        onclick="clearTestsSearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterAll" value="all" checked onchange="filterTests()">
                                <label class="btn btn-outline-secondary" for="filterAll">
                                    <i class="fas fa-list me-1"></i>
                                    <span class="d-none d-sm-inline">–í—Å–µ</span>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterSpelling" value="spelling" onchange="filterTests()">
                                <label class="btn btn-outline-primary" for="filterSpelling">
                                    <i class="fas fa-spell-check"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterPunctuation" value="punctuation" onchange="filterTests()">
                                <label class="btn btn-outline-info" for="filterPunctuation">
                                    <i class="fas fa-exclamation"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterOrthoeopy" value="orthoeopy" onchange="filterTests()">
                                <label class="btn btn-outline-success" for="filterOrthoeopy">
                                    <i class="fas fa-volume-up"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterRegular" value="regular" onchange="filterTests()">
                                <label class="btn btn-outline-secondary" for="filterRegular">
                                    <i class="fas fa-list-ul"></i>
                                </label>
                            </div>

                            <span class="badge bg-secondary" id="testsCount">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-compact mb-0" id="testsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</th>
                                    <th class="d-none d-lg-table-cell">–¢–∏–ø</th>
                                    <th class="text-center">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</th>
                                    <th class="text-center">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</th>
                                    <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                @* –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è *@
                                @foreach (var test in Model.SpellingTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="spelling"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-primary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-spell-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-primary test-type-badge">
                                                <i class="fas fa-spell-check me-1"></i>
                                                –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="spelling">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="spelling">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="SpellingTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è *@
                                @foreach (var test in Model.PunctuationTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="punctuation"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-info test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-exclamation"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-info test-type-badge">
                                                <i class="fas fa-exclamation me-1"></i>
                                                –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="punctuation">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="punctuation">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="PunctuationTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –û—Ä—Ñ–æ—ç–ø–∏—è *@
                                @foreach (var test in Model.OrthoeopyTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="orthoeopy"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-success test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-volume-up"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-success test-type-badge">
                                                <i class="fas fa-volume-up me-1"></i>
                                                –û—Ä—Ñ–æ—ç–ø–∏—è
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="orthoeopy">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="orthoeopy">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="OrthoeopyTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã *@
                                @foreach (var test in Model.RegularTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="regular"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge bg-secondary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-list-ul"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block">@test.Title</strong>
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        @test.CreatedAt.ToString("dd.MM.yyyy")
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge bg-secondary test-type-badge">
                                                <i class="fas fa-list-ul me-1"></i>
                                                –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success test-count-completed" data-test-id="@test.Id" data-test-type="regular">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning test-count-progress" data-test-id="@test.Id" data-test-type="regular">0</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="RegularTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">–î–µ—Ç–∞–ª–∏</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @if (!Model.SpellingTests.Any() && !Model.PunctuationTests.Any() && 
                                    !Model.OrthoeopyTests.Any() && !Model.RegularTests.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <i class="fas fa-clipboard-list text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                                            <h5 class="text-muted mb-2">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</h5>
                                            <p class="text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testResultModalTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="testResultModalBody">
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="~/js/teacher-dashboard-signalr.js" asp-append-version="true"></script>
    
    <script>
        var TEACHER_ID = '@Model.Teacher.Id';
        var notificationCount = 0;
        var allActivities = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Dashboard');

            document.getElementById('signalr-status').style.display = 'inline-flex';

            loadRecentActivity();

            window.dashboardSignalR = new TeacherDashboardSignalR(TEACHER_ID);
            window.dashboardSignalR.start();

            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterActivities);
            }

            updateTestsCount();
        });

        function loadRecentActivity() {
            fetch('/TeacherDashboard/GetRecentActivity')
                .then(response => response.json())
                .then(data => {
                    allActivities = data;
                    renderActivities(allActivities);
                    updateActivityCount();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
                    document.getElementById('activity-feed').innerHTML = 
                        '<tr><td colspan="5" class="text-center py-5 text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td></tr>';
                });
        }

        function renderActivities(activities) {
            var tbody = document.getElementById('activity-feed');
            if (!tbody) return;

            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td></tr>';
                return;
            }

            tbody.innerHTML = activities.map(function(activity) {
                var statusBadge = activity.status === 'completed' 
                    ? '<span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω</span>'
                    : activity.status === 'started'
                    ? '<span class="badge bg-info">–ù–∞—á–∞—Ç</span>'
                    : '<span class="badge bg-warning">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>';
                
                var percentageBadge = activity.percentage >= 80 
                    ? '<span class="badge bg-success">' + activity.percentage.toFixed(1) + '%</span>'
                    : activity.percentage >= 60
                    ? '<span class="badge bg-warning">' + activity.percentage.toFixed(1) + '%</span>'
                    : '<span class="badge bg-danger">' + activity.percentage.toFixed(1) + '%</span>';

                var gradeBadge = activity.percentage >= 91 
                    ? '<span class="badge bg-success">5</span>'
                    : activity.percentage >= 80
                    ? '<span class="badge bg-info">4</span>'
                    : activity.percentage >= 60
                    ? '<span class="badge bg-warning">3</span>'
                    : '<span class="badge bg-danger">2</span>';

                var testTypeIcon = {
                    'spelling': 'fa-spell-check',
                    'punctuation': 'fa-exclamation',
                    'orthoeopy': 'fa-volume-up',
                    'regular': 'fa-list-ul'
                }[activity.testType] || 'fa-clipboard-list';

                var testTypeColor = {
                    'spelling': 'primary',
                    'punctuation': 'info',
                    'orthoeopy': 'success',
                    'regular': 'secondary'
                }[activity.testType] || 'secondary';

                var lastActivity = new Date(activity.lastActivityAt);
                var timeStr = lastActivity.toLocaleString('ru-RU', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                var duration = '';
                if (activity.completedAt) {
                    var start = new Date(activity.startedAt);
                    var end = new Date(activity.completedAt);
                    var diff = Math.floor((end - start) / 1000 / 60);
                    duration = diff + ' –º–∏–Ω';
                }

                var actionButton = activity.status === 'completed' && activity.testResultId
                    ? '<button class="btn btn-sm btn-outline-info" onclick="showTestResult(\'' + activity.testType + '\', ' + activity.testResultId + ', \'' + activity.studentName + '\')">' +
                      '<i class="fas fa-eye"></i> <span class="d-none d-md-inline">–ü–æ–¥—Ä–æ–±–Ω–æ</span></button>'
                    : '';

                return '<tr data-search-text="' + 
                    (activity.studentName + ' ' + activity.testTitle).toLowerCase() + '">' +
                    '<td>' +
                    '<div class="d-flex align-items-center gap-2">' +
                    '<i class="fas ' + testTypeIcon + ' text-' + testTypeColor + '"></i>' +
                    '<div>' +
                    '<strong>' + activity.studentName + '</strong> - ' + activity.testTitle +
                    '<br><small class="text-muted">' + statusBadge + '</small>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '<td class="text-center d-none d-md-table-cell">' + percentageBadge + '</td>' +
                    '<td class="text-center">' + (activity.status === 'completed' ? gradeBadge : '-') + '</td>' +
                    '<td class="text-center d-none d-md-table-cell"><small>' + timeStr + '</small></td>' +
                    '<td class="text-center">' + actionButton + '</td>' +
                    '</tr>';
            }).join('');
        }

        function filterActivities() {
            var searchInput = document.getElementById('activitySearchInput');
            var searchText = searchInput ? searchInput.value.toLowerCase() : '';
            var rows = document.querySelectorAll('#activity-feed tr[data-search-text]');
            var visibleCount = 0;

            rows.forEach(function(row) {
                var text = row.getAttribute('data-search-text') || '';
                if (text.includes(searchText)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateActivityCount(visibleCount);
            
            var clearButton = document.getElementById('clearActivitySearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }

            var noResults = document.getElementById('noActivityResults');
            if (noResults) {
                noResults.style.display = visibleCount === 0 && searchText ? 'block' : 'none';
            }
        }

        function clearActivitySearch() {
            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterActivities();
            }
        }

        function refreshActivity() {
            loadRecentActivity();
        }

        function updateActivityCount(count) {
            var countElement = document.getElementById('activityCount');
            if (countElement) {
                var total = count !== undefined ? count : document.querySelectorAll('#activity-feed tr[data-search-text]').length;
                countElement.textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ: ' + total;
            }
        }

        function filterTests() {
            var searchInput = document.getElementById('testsSearchInput');
            var searchText = searchInput ? searchInput.value.toLowerCase() : '';
            var selectedType = document.querySelector('input[name="testTypeFilter"]:checked')?.value || 'all';
            var rows = document.querySelectorAll('#testsTableBody .test-row');
            var visibleCount = 0;

            rows.forEach(function(row) {
                var rowType = row.getAttribute('data-test-type') || '';
                var rowText = row.getAttribute('data-search-text') || '';
                
                var typeMatch = selectedType === 'all' || rowType === selectedType;
                var textMatch = rowText.includes(searchText);
                
                if (typeMatch && textMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateTestsCount(visibleCount);
            
            var clearButton = document.getElementById('clearTestsSearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }
        }

        function clearTestsSearch() {
            var searchInput = document.getElementById('testsSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterTests();
            }
        }

        function updateTestsCount(count) {
            var countElement = document.getElementById('testsCount');
            if (countElement) {
                var total = count !== undefined ? count : document.querySelectorAll('#testsTableBody .test-row').length;
                countElement.textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ: ' + total;
            }
        }

        function showTestResult(testType, testResultId, studentName) {
            window.showTestResultModal(testType, testResultId, studentName);
        }

        function prependActivity(activity) {
            allActivities.unshift(activity);
            if (allActivities.length > 50) {
                allActivities = allActivities.slice(0, 50);
            }
            renderActivities(allActivities);
            updateActivityCount();
        }

        function updateStats(action) {
            if (action === 'completed') {
                var completedToday = document.getElementById('stats-completed-today');
                if (completedToday) {
                    var count = parseInt(completedToday.textContent) || 0;
                    completedToday.textContent = count + 1;
                }
            } else if (action === 'started') {
                var inProgress = document.getElementById('stats-in-progress');
                if (inProgress) {
                    var count = parseInt(inProgress.textContent) || 0;
                    inProgress.textContent = count + 1;
                }
            }
        }
    </script>
}

