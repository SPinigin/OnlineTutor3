@model OnlineTutor3.Web.ViewModels.TeacherDashboardViewModel
@{
    ViewData["Title"] = "Панель мониторинга";
}

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2 page-header">
        <div>
            <h4 class="mb-0 d-flex align-items-center gap-2 page-header-title">
                <i class="fas fa-tachometer-alt gradient-icon-green"></i>
                <span>Панель мониторинга</span>
            </h4>
            <p class="text-muted-modern mb-0 small">Активность студентов в реальном времени</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div id="signalr-status" class="signalr-status" style="display: none;">
                <i class="fas fa-circle text-muted-modern me-1"></i>
                <span class="text-muted-modern">Подключение...</span>
            </div>
            <div id="signalr-activity-indicator"></div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3 stat-cards-row">
        <div class="flex-fill">
            <div class="card modern-card stat-card h-100">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-card-value">@Model.TotalActiveTests</div>
                    <small class="stat-card-label">Активных тестов</small>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card modern-card stat-card h-100">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-value" id="stats-in-progress">@Model.TotalStudentsInProgress</div>
                    <small class="stat-card-label">Проходят сейчас</small>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card modern-card stat-card h-100">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-value" id="stats-completed-today">@Model.TotalCompletedToday</div>
                    <small class="stat-card-label">Завершено сегодня</small>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card modern-card stat-card h-100">
                <div class="card-body text-center py-2 px-2">
                    <div class="stat-card-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="stat-card-value" id="stats-notifications">0</div>
                    <small class="stat-card-label">Уведомлений сегодня</small>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link nav-link-modern active" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                <i class="fas fa-stream nav-link-icon"></i> Активность
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link nav-link-modern" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
                <i class="fas fa-list nav-link-icon"></i> Тесты
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="activity" role="tabpanel">
            <div class="card shadow-sm border-0 mb-3 search-filter-card">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search nav-link-icon"></i>
                            <strong class="small text-dark-modern">Поиск:</strong>
                        </div>
            
                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control form-control-sm border-start-0 form-control-modern" 
                                       id="activitySearchInput" 
                                       placeholder="Поиск по имени студента или названию теста..."
                                       onkeyup="filterActivities()">
                                <button class="btn btn-sm btn-modern-outline-secondary" 
                                        type="button" 
                                        id="clearActivitySearch"
                                        onclick="clearActivitySearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
            
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-modern-outline-primary" onclick="refreshActivity()">
                                <i class="fas fa-sync"></i>
                                <span class="d-none d-sm-inline ms-1">Обновить</span>
                            </button>
                            <span class="badge badge-modern-secondary" id="activityCount">
                                Показано: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card modern-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0" id="activityTable">
                            <thead>
                                <tr>
                                    <th>Уведомление</th>
                                    <th class="text-center d-none d-md-table-cell">Процент</th>
                                    <th class="text-center">Оценка</th>
                                    <th class="text-center d-none d-md-table-cell">Время</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="activity-feed">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <p class="text-muted-modern mt-2 mb-0 small">Загрузка активности...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="noActivityResults" class="empty-state-large" style="display: none;">
                        <i class="fas fa-search empty-state-icon"></i>
                        <h5 class="empty-state-title">Ничего не найдено</h5>
                        <p class="empty-state-text">Попробуйте изменить поисковый запрос</p>
                        <button class="btn btn-modern-outline-primary btn-sm" onclick="clearActivitySearch()">
                            <i class="fas fa-redo"></i> Сбросить поиск
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tests" role="tabpanel">
            <div class="card shadow-sm border-0 mb-3 search-filter-card">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search nav-link-icon"></i>
                            <strong class="small text-dark-modern">Поиск:</strong>
                        </div>

                        <div class="flex-grow-1" style="max-width: 400px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text"
                                       class="form-control form-control-sm border-start-0 form-control-modern"
                                       id="testsSearchInput"
                                       placeholder="Поиск по названию теста..."
                                       onkeyup="filterTests()">
                                <button class="btn btn-sm btn-modern-outline-secondary"
                                        type="button"
                                        id="clearTestsSearch"
                                        onclick="clearTestsSearch()"
                                        style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterAll" value="all" checked onchange="filterTests()">
                                <label class="btn btn-modern-outline-secondary" for="filterAll">
                                    <i class="fas fa-list me-1"></i>
                                    <span class="d-none d-sm-inline">Все</span>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterSpelling" value="spelling" onchange="filterTests()">
                                <label class="btn btn-modern-outline-primary" for="filterSpelling">
                                    <i class="fas fa-spell-check"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterPunctuation" value="punctuation" onchange="filterTests()">
                                <label class="btn btn-modern-outline-info" for="filterPunctuation">
                                    <i class="fas fa-quote-right"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterOrthoeopy" value="orthoeopy" onchange="filterTests()">
                                <label class="btn btn-modern-outline-success" for="filterOrthoeopy">
                                    <i class="fas fa-volume-up"></i>
                                </label>

                                <input type="radio" class="btn-check" name="testTypeFilter" id="filterRegular" value="regular" onchange="filterTests()">
                                <label class="btn btn-modern-outline-secondary" for="filterRegular">
                                    <i class="fas fa-clipboard-check"></i>
                                </label>
                            </div>

                            <span class="badge badge-modern-secondary" id="testsCount">
                                Показано: 0
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card modern-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0" id="testsTable">
                            <thead>
                                <tr>
                                    <th>Название теста</th>
                                    <th class="d-none d-lg-table-cell">Тип</th>
                                    <th class="text-center">Завершили</th>
                                    <th class="text-center test-header-nowrap">В процессе</th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                @foreach (var test in Model.SpellingTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="spelling"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-primary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-spell-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        @if (!string.IsNullOrEmpty(test.Description))
                                                        {
                                                            @test.Description
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-primary test-type-badge">
                                                <i class="fas fa-spell-check me-1"></i>
                                                Орфография
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var spellingKey = $"spelling_{test.Id}";
                                                var spellingStats = Model.TestStatistics.ContainsKey(spellingKey) ? Model.TestStatistics[spellingKey] : (Completed: 0, InProgress: 0);
                                            }
                                            <span class="badge badge-modern-success test-count-completed test-count-badge" data-test-id="@test.Id" data-test-type="spelling">@spellingStats.Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress test-count-badge" data-test-id="@test.Id" data-test-type="spelling">@spellingStats.InProgress</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="SpellingTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">Детали</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @foreach (var test in Model.PunctuationTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="punctuation"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-info test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-quote-right"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        @if (!string.IsNullOrEmpty(test.Description))
                                                        {
                                                            @test.Description
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-info test-type-badge">
                                                <i class="fas fa-quote-right me-1"></i>
                                                Пунктуация
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var punctuationKey = $"punctuation_{test.Id}";
                                                var punctuationStats = Model.TestStatistics.ContainsKey(punctuationKey) ? Model.TestStatistics[punctuationKey] : (Completed: 0, InProgress: 0);
                                            }
                                            <span class="badge badge-modern-success test-count-completed test-count-badge" data-test-id="@test.Id" data-test-type="punctuation">@punctuationStats.Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress test-count-badge" data-test-id="@test.Id" data-test-type="punctuation">@punctuationStats.InProgress</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="PunctuationTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">Детали</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @foreach (var test in Model.OrthoeopyTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="orthoeopy"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-success test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-volume-up"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        @if (!string.IsNullOrEmpty(test.Description))
                                                        {
                                                            @test.Description
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-success test-type-badge">
                                                <i class="fas fa-volume-up me-1"></i>
                                                Орфоэпия
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var orthoeopyKey = $"orthoeopy_{test.Id}";
                                                var orthoeopyStats = Model.TestStatistics.ContainsKey(orthoeopyKey) ? Model.TestStatistics[orthoeopyKey] : (Completed: 0, InProgress: 0);
                                            }
                                            <span class="badge badge-modern-success test-count-completed test-count-badge" data-test-id="@test.Id" data-test-type="orthoeopy">@orthoeopyStats.Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress test-count-badge" data-test-id="@test.Id" data-test-type="orthoeopy">@orthoeopyStats.InProgress</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="OrthoeopyTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">Детали</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @foreach (var test in Model.RegularTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="regular"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-secondary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-clipboard-check"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        @if (!string.IsNullOrEmpty(test.Description))
                                                        {
                                                            @test.Description
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-secondary test-type-badge">
                                                <i class="fas fa-clipboard-check me-1"></i>
                                                Классический
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var regularKey = $"regular_{test.Id}";
                                                var regularStats = Model.TestStatistics.ContainsKey(regularKey) ? Model.TestStatistics[regularKey] : (Completed: 0, InProgress: 0);
                                            }
                                            <span class="badge badge-modern-success test-count-completed test-count-badge" data-test-id="@test.Id" data-test-type="regular">@regularStats.Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress test-count-badge" data-test-id="@test.Id" data-test-type="regular">@regularStats.InProgress</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="RegularTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">Детали</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @foreach (var test in Model.NotParticleTests)
                                {
                                    <tr class="test-row"
                                        data-test-type="notparticle"
                                        data-test-id="@test.Id"
                                        data-search-text="@test.Title.ToLower()">
                                        <td>
                                            <div class="d-flex align-items-start gap-2">
                                                <span class="badge badge-modern-secondary test-type-badge d-lg-none mt-1">
                                                    <i class="fas fa-minus-circle"></i>
                                                </span>
                                                <div class="flex-grow-1 min-w-0">
                                                    <strong class="d-block text-dark-modern">@test.Title</strong>
                                                    <small class="text-muted-modern">
                                                        @if (!string.IsNullOrEmpty(test.Description))
                                                        {
                                                            @test.Description
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">—</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <span class="badge badge-modern-secondary test-type-badge">
                                                <i class="fas fa-minus-circle me-1"></i>
                                                Частица "не"
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            @{
                                                var notParticleKey = $"notparticle_{test.Id}";
                                                var notParticleStats = Model.TestStatistics.ContainsKey(notParticleKey) ? Model.TestStatistics[notParticleKey] : (Completed: 0, InProgress: 0);
                                            }
                                            <span class="badge badge-modern-success test-count-completed test-count-badge" data-test-id="@test.Id" data-test-type="notparticle">@notParticleStats.Completed</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-modern-warning test-count-progress test-count-badge" data-test-id="@test.Id" data-test-type="notparticle">@notParticleStats.InProgress</span>
                                        </td>
                                        <td class="text-center">
                                            <a asp-controller="NotParticleTest" asp-action="Details" asp-route-id="@test.Id" class="btn btn-sm btn-modern-outline-primary">
                                                <i class="fas fa-eye"></i>
                                                <span class="d-none d-md-inline ms-1">Детали</span>
                                            </a>
                                        </td>
                                    </tr>
                                }

                                @if (!Model.SpellingTests.Any() && !Model.PunctuationTests.Any() && 
                                    !Model.OrthoeopyTests.Any() && !Model.RegularTests.Any() && !Model.NotParticleTests.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="empty-state-large">
                                                <i class="fas fa-clipboard-list empty-state-icon"></i>
                                                <h5 class="empty-state-title">Нет активных тестов</h5>
                                                <p class="empty-state-text">Создайте тесты, чтобы отслеживать активность студентов</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content modern-modal-content">
                <div class="modal-header modern-modal-header">
                    <h5 class="modal-title modern-modal-title" id="testResultModalTitle">Результат теста</h5>
                    <button type="button" class="btn-close modern-btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modern-modal-body" id="testResultModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/teacher-dashboard.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="~/js/teacher-dashboard-signalr.js" asp-append-version="true"></script>
    
    <script>
        var TEACHER_ID = '@Model.Teacher.Id';
        var notificationCount = 0;
        var allActivities = [];

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('signalr-status').style.display = 'inline-flex';

            loadRecentActivity();

            window.dashboardSignalR = new TeacherDashboardSignalR(TEACHER_ID);
            window.dashboardSignalR.start();

            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterActivities);
            }

            updateTestsCount();
        });

        function loadRecentActivity() {
            fetch('/TeacherDashboard/GetRecentActivity')
                .then(response => response.json())
                .then(data => {
                    allActivities = data;
                    renderActivities(allActivities);
                    updateActivityCount();
                })
                .catch(error => {
                    document.getElementById('activity-feed').innerHTML = 
                        '<tr><td colspan="5" class="text-center py-5"><div class="empty-state-small"><small class="empty-state-text text-danger">Ошибка загрузки активности</small></div></td></tr>';
                });
        }

        function renderActivities(activities) {
            displayActivities(activities);
        }

        function displayActivities(activities) {
            var feed = document.getElementById('activity-feed');
            var noResults = document.getElementById('noActivityResults');
            
            if (!activities || activities.length === 0) {
                feed.innerHTML = 
                    '<tr><td colspan="5" class="text-center py-5">' +
                    '<div class="empty-state-small">' +
                    '<small class="empty-state-text">Нет активности</small>' +
                    '</div>' +
                    '</td></tr>';
                
                if (noResults) noResults.style.display = 'none';
                updateActivityCount(0);
                return;
            }

            var groupedActivities = groupActivitiesByDate(activities);
            
            var html = '';
            var totalCount = 0;
            
            Object.keys(groupedActivities).forEach(function(dateKey, index) {
                var group = groupedActivities[dateKey];
                var isToday = index === 0;
                var isExpanded = isToday;
                
                html += createDateGroupHeader(group.label, group.activities.length, dateKey, isExpanded);
                
                group.activities.forEach(function(activity) {
                    html += createActivityRow(activity, dateKey, isExpanded);
                    totalCount++;
                });
            });
            
            feed.innerHTML = html;
            if (noResults) noResults.style.display = 'none';
            updateActivityCount(totalCount);
        }

        function groupActivitiesByDate(activities) {
            var groups = {};
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            
            var yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            activities.forEach(function(activity) {
                var activityDate = new Date(activity.lastActivityAt);
                activityDate.setHours(0, 0, 0, 0);
                
                var dateKey;
                var label;
                
                if (activityDate.getTime() === today.getTime()) {
                    dateKey = 'today';
                    label = 'Сегодня';
                } else if (activityDate.getTime() === yesterday.getTime()) {
                    dateKey = 'yesterday';
                    label = 'Вчера';
                } else {
                    dateKey = 'date_' + activityDate.getTime();
                    label = formatDate(activityDate);
                }
                
                if (!groups[dateKey]) {
                    groups[dateKey] = {
                        label: label,
                        date: activityDate,
                        activities: []
                    };
                }
                
                groups[dateKey].activities.push(activity);
            });
            
            var sortedGroups = {};
            Object.keys(groups)
                .sort(function(a, b) {
                    return groups[b].date - groups[a].date;
                })
                .forEach(function(key) {
                    sortedGroups[key] = groups[key];
                });
            
            return sortedGroups;
        }


        function createDateGroupHeader(label, count, dateKey, isExpanded) {
            var icon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';
            
            return '<tr class="date-group-header" onclick="toggleDateGroup(\'' + dateKey + '\')" style="cursor: pointer; background-color: #f8f9fa;">' +
                   '<td colspan="5" class="py-2 px-3">' +
                   '<div class="d-flex align-items-center justify-content-between">' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<i class="fas ' + icon + ' text-primary date-group-icon" id="icon-' + dateKey + '"></i>' +
                   '<strong class="text-dark-modern">' + label + '</strong>' +
                   '<span class="badge badge-modern-secondary badge-sm">' + count + '</span>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   '</tr>';
        }


        function createActivityRow(activity, dateKey, isVisible) {
            var statusBadge = activity.status === 'completed' 
                ? '<span class="badge badge-modern-success">Завершен</span>'
                : activity.status === 'started'
                ? '<span class="badge badge-modern-info">Начат</span>'
                : '<span class="badge badge-modern-warning">В процессе</span>';
            
            var percentageBadge = '';
            var gradeBadge = '';

            if (activity.status === 'completed' && activity.percentage !== undefined) {
                var grade = activity.percentage >= 100.0 ? 5 :
                           activity.percentage >= 91.0 ? 4 :
                           activity.percentage >= 80.0 ? 3 : 2;
                var gradeColor = grade === 5 ? 'success' :
                                grade === 4 ? 'info' :
                                grade === 3 ? 'warning' : 'danger';
                var percentColor = gradeColor;
                percentageBadge = '<span class="badge badge-modern-' + percentColor + '" style="font-size: 1rem; padding: 0.25rem 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; min-width: 1.5rem; line-height: 1;">' + 
                               activity.percentage.toFixed(1) + '%</span>';
                gradeBadge = '<span class="badge badge-modern-' + gradeColor + '" style="font-size: 1rem; padding: 0.25rem 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; min-width: 1.5rem; line-height: 1;">' + grade + '</span>';
            } else {
                percentageBadge = '<span class="text-muted-modern">—</span>';
                gradeBadge = '<span class="text-muted-modern">—</span>';
            }

            var testTypeIcon = {
                'spelling': 'fa-spell-check',
                'punctuation': 'fa-quote-right',
                'orthoeopy': 'fa-volume-up',
                'regular': 'fa-clipboard-check'
            }[activity.testType] || 'fa-clipboard-list';

            var testTypeIconClass = {
                'spelling': 'nav-link-icon',
                'punctuation': 'nav-link-icon-blue',
                'orthoeopy': 'nav-link-icon-green',
                'regular': 'nav-link-icon'
            }[activity.testType] || 'nav-link-icon';

            var lastActivity = new Date(activity.lastActivityAt);
            var timeStr = lastActivity.toLocaleString('ru-RU', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            var actionButton = activity.status === 'completed' && activity.testResultId
                ? '<button class="btn btn-sm btn-modern-outline-info" onclick="showTestResult(\'' + activity.testType + '\', ' + activity.testResultId + ', \'' + activity.studentName + '\')">' +
                  '<i class="fas fa-eye"></i> <span class="d-none d-md-inline">Детали</span></button>'
                : '';

            var displayStyle = isVisible ? '' : 'display: none;';

            return '<tr class="activity-row date-group-' + dateKey + '" ' +
                   'data-search-text="' + (activity.studentName + ' ' + activity.testTitle).toLowerCase() + '" ' +
                   'data-date-group="' + dateKey + '" ' +
                   'style="' + displayStyle + '">' +
                   '<td>' +
                   '<div class="d-flex align-items-center gap-2">' +
                   '<i class="fas ' + testTypeIcon + ' ' + testTypeIconClass + '"></i>' +
                   '<div>' +
                   '<strong class="text-dark-modern">' + activity.studentName + '</strong> - <span class="text-dark-modern">' + activity.testTitle + '</span>' +
                   '<br><small class="text-muted-modern">' + statusBadge + '</small>' +
                   '</div>' +
                   '</div>' +
                   '</td>' +
                   '<td class="text-center d-none d-md-table-cell">' + percentageBadge + '</td>' +
                   '<td class="text-center">' + gradeBadge + '</td>' +
                   '<td class="text-center d-none d-md-table-cell"><small class="text-muted-modern">' + timeStr + '</small></td>' +
                   '<td class="text-center">' + actionButton + '</td>' +
                   '</tr>';
        }


        function toggleDateGroup(dateKey) {
            var rows = document.querySelectorAll('.date-group-' + dateKey);
            var icon = document.getElementById('icon-' + dateKey);
            
            if (!rows.length || !icon) return;
            
            var isVisible = rows[0].style.display !== 'none';
            
            rows.forEach(function(row) {
                row.style.display = isVisible ? 'none' : '';
            });
            
            icon.className = isVisible ? 
                'fas fa-chevron-right text-primary date-group-icon' : 
                'fas fa-chevron-down text-primary date-group-icon';
            
            filterActivities();
        }


        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
        }

        function filterActivities() {
            var searchInput = document.getElementById('activitySearchInput');
            if (!searchInput) return;

            var searchText = searchInput.value.toLowerCase().trim();

            var rows = document.querySelectorAll('.activity-row');
            var visibleCount = 0;
            
            var groupCounts = {};

            rows.forEach(function(row) {
                var rowSearchText = row.getAttribute('data-search-text') || '';
                var dateGroup = row.getAttribute('data-date-group');
                var groupIcon = document.getElementById('icon-' + dateGroup);
                var isGroupExpanded = groupIcon && groupIcon.classList.contains('fa-chevron-down');
                
                if (!groupCounts[dateGroup]) {
                    groupCounts[dateGroup] = { total: 0, visible: 0 };
                }
                groupCounts[dateGroup].total++;
                
                var matchesSearch = !searchText || rowSearchText.includes(searchText);
                
                if (matchesSearch && isGroupExpanded) {
                    row.style.display = '';
                    groupCounts[dateGroup].visible++;
                    visibleCount++;
                } else if (matchesSearch && !isGroupExpanded) {
                    row.style.display = 'none';
                } else {
                    row.style.display = 'none';
                }
            });

            Object.keys(groupCounts).forEach(function(dateGroup) {
                var header = document.querySelector('.date-group-header [id^="icon-' + dateGroup + '"]');
                if (header) {
                    var badge = header.parentElement.parentElement.querySelector('.badge');
                    if (badge) {
                        var count = groupCounts[dateGroup];
                        if (searchText && count.visible !== count.total) {
                            badge.textContent = count.visible + ' / ' + count.total;
                            badge.classList.remove('badge-modern-secondary');
                            badge.classList.add('badge-modern-primary');
                        } else {
                            badge.textContent = count.total;
                            badge.classList.remove('badge-modern-primary');
                            badge.classList.add('badge-modern-secondary');
                        }
                    }
                }
            });

            var noResults = document.getElementById('noActivityResults');
            var tableBody = document.getElementById('activity-feed');
            
            if (visibleCount === 0 && searchText) {
                if (tableBody) tableBody.style.display = 'none';
                if (noResults) noResults.style.display = 'block';
            } else {
                if (tableBody) tableBody.style.display = '';
                if (noResults) noResults.style.display = 'none';
            }

            updateActivityCount(visibleCount);
            
            var clearButton = document.getElementById('clearActivitySearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }
        }

        function clearActivitySearch() {
            var searchInput = document.getElementById('activitySearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterActivities();
            }
        }

        function refreshActivity() {
            loadRecentActivity();
        }

        function updateActivityCount(count) {
            var countElement = document.getElementById('activityCount');
            if (countElement) {
                var total = document.querySelectorAll('.activity-row').length;
                if (count !== undefined) {
                    countElement.textContent = 'Показано: ' + count + (count !== total ? ' из ' + total : '');
                } else {
                    countElement.textContent = 'Показано: ' + total;
                }
            }
        }

        function filterTests() {
            var searchInput = document.getElementById('testsSearchInput');
            var searchText = searchInput ? searchInput.value.toLowerCase() : '';
            var selectedType = document.querySelector('input[name="testTypeFilter"]:checked')?.value || 'all';
            var rows = document.querySelectorAll('#testsTableBody .test-row');
            var visibleCount = 0;

            rows.forEach(function(row) {
                var rowType = row.getAttribute('data-test-type') || '';
                var rowText = row.getAttribute('data-search-text') || '';
                
                var typeMatch = selectedType === 'all' || rowType === selectedType;
                var textMatch = rowText.includes(searchText);
                
                if (typeMatch && textMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateTestsCount(visibleCount);
            
            var clearButton = document.getElementById('clearTestsSearch');
            if (clearButton) {
                clearButton.style.display = searchText ? 'inline-block' : 'none';
            }
        }

        function clearTestsSearch() {
            var searchInput = document.getElementById('testsSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterTests();
            }
        }

        function updateTestsCount(count) {
            var countElement = document.getElementById('testsCount');
            if (countElement) {
                var total = count !== undefined ? count : document.querySelectorAll('#testsTableBody .test-row').length;
                countElement.textContent = 'Показано: ' + total;
            }
        }

        function showTestResult(testType, testResultId, studentName) {
            window.showTestResultModal(testType, testResultId, studentName);
        }

        function prependActivity(activity) {
            allActivities.unshift(activity);
            if (allActivities.length > 100) {
                allActivities = allActivities.slice(0, 100);
            }
            displayActivities(allActivities);
            updateActivityCount();
        }

        function updateStats(action) {
            if (action === 'completed') {
                var completedToday = document.getElementById('stats-completed-today');
                if (completedToday) {
                    var count = parseInt(completedToday.textContent) || 0;
                    completedToday.textContent = count + 1;
                }
            } else if (action === 'started') {
                var inProgress = document.getElementById('stats-in-progress');
                if (inProgress) {
                    var count = parseInt(inProgress.textContent) || 0;
                    inProgress.textContent = count + 1;
                }
            }
        }
    </script>
}

