@model IEnumerable<OnlineTutor3.Domain.Entities.Class>
@{
    ViewData["Title"] = "Управление классами";
    var activeClasses = Model.Count(c => c.IsActive);
    var inactiveClasses = Model.Count(c => !c.IsActive);
}

<div class="page-header">
    <h4 class="page-header-title">
        <i class="fas fa-graduation-cap page-header-icon"></i>
        <span>Управление классами</span>
    </h4>
    <div>
        <a asp-action="Create" class="btn btn-modern-success">
            <i class="fas fa-plus"></i> Создать класс
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="empty-state-large">
        <div class="empty-state-large-icon">
            <i class="fas fa-users"></i>
        </div>
        <h4 class="empty-state-large-title">У вас пока нет классов</h4>
        <p class="empty-state-large-text">Создайте свой первый класс для начала работы с учениками</p>
        <a asp-action="Create" class="btn btn-modern-primary">
            <i class="fas fa-plus"></i> Создать первый класс
        </a>
    </div>
}
else
{
    <div class="row mb-3 align-items-center">
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <h6 class="mb-0">
                <i class="fas fa-users"></i> 
                <span>Всего классов: @Model.Count()</span>
            </h6>
        </div>
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" 
                       id="searchInput" 
                       class="form-control" 
                       placeholder="Поиск по названию..."
                       autocomplete="off">
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="btn-group btn-group-sm w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" data-filter="all">
                    Все (@Model.Count())
                </button>
                <button type="button" class="btn btn-outline-success" data-filter="active">
                    Активные (@activeClasses)
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="inactive">
                    Неактивные (@inactiveClasses)
                </button>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm modern-card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle modern-table mb-0">
                    <thead>
                        <tr>
                            <th style="min-width: 40px;" class="text-center">
                                <i class="fas fa-check-circle"></i>
                            </th>
                            <th style="min-width: 120px;">Название</th>
                            <th style="min-width: 100px;">Описание</th>
                            <th style="min-width: 70px;" class="text-center">
                                Ученики
                            </th>
                            <th style="min-width: 90px;">Создан</th>
                            <th style="min-width: 140px;" class="text-center">Действия</th>
                        </tr>
                    </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr class="class-row @(item.IsActive ? "" : "table-secondary")" 
                        data-status="@(item.IsActive ? "active" : "inactive")"
                        data-class-id="@item.Id"
                        style="cursor: pointer;">
                        <td class="text-center">
                            <span class="badge bg-@(item.IsActive ? "success" : "secondary")">
                                <i class="fas fa-@(item.IsActive ? "check-circle" : "times-circle")"></i>
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-graduation-cap me-2" style="color: #667eea;"></i>
                                <div>
                                    <strong class="text-dark-modern">@item.Name</strong>
                                </div>
                            </div>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.Description))
                            {
                                <small class="text-muted-modern">@item.Description</small>
                            }
                            else
                            {
                                <span class="text-muted-modern fst-italic">Описание не указано</span>
                            }
                        </td>
                        <td class="text-center">
                            @{
                                var studentsCountDict = ViewBag.StudentsCountDict as Dictionary<int, int> ?? new Dictionary<int, int>();
                                var studentsCount = studentsCountDict.ContainsKey(item.Id) ? studentsCountDict[item.Id] : 0;
                            }
                            <span class="badge badge-modern-primary rounded-pill">@studentsCount</span>
                        </td>
                        <td>
                            <small class="text-muted-modern">
                                <i class="fas fa-calendar"></i>
                                @item.CreatedAt.ToString("dd.MM.yyyy")
                            </small>
                        </td>
                        <td class="text-center" onclick="event.stopPropagation();">
                            <div class="d-flex gap-1 justify-content-center">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-modern-outline-info" title="Детали">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-modern-outline-primary" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form asp-action="ToggleActive" asp-route-id="@item.Id" method="post" class="d-inline" style="margin: 0;">
                                    <button type="submit" class="btn btn-sm btn-modern-outline-@(item.IsActive ? "warning" : "success")" title="@(item.IsActive ? "Деактивировать" : "Активировать")">
                                        <i class="fas fa-@(item.IsActive ? "toggle-on" : "toggle-off")"></i>
                                    </button>
                                </form>
                                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-modern-outline-danger" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Обработка клика на строку таблицы для перехода к деталям
            $('.class-row').on('click', function(e) {
                if ($(e.target).closest('a, button, form').length === 0) {
                    var classId = $(this).data('class-id');
                    if (classId) {
                        window.location.href = '@Url.Action("Details", "Class")/' + classId;
                    }
                }
            });

            // Поиск
            $('#searchInput').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('.class-row').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Фильтр по статусу
            $('[data-filter]').on('click', function() {
                var filter = $(this).data('filter');
                $('[data-filter]').removeClass('active');
                $(this).addClass('active');
                
                $('.class-row').each(function() {
                    var status = $(this).data('status');
                    if (filter === 'all' || status === filter) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
        });
    </script>
}

