@model OnlineTutor3.Web.ViewModels.AssignmentHistoryInfo
@using OnlineTutor3.Domain.Entities

@{
    var allResults = new List<TestResult>();
    allResults.AddRange(Model.SpellingResults.Cast<TestResult>());
    allResults.AddRange(Model.PunctuationResults.Cast<TestResult>());
    allResults.AddRange(Model.OrthoeopyResults.Cast<TestResult>());
    allResults.AddRange(Model.RegularResults.Cast<TestResult>());
    allResults = allResults.OrderByDescending(r => r.CompletedAt ?? r.StartedAt).ToList();
}

@if (allResults.Any())
{
    <div class="table-responsive">
        <table class="table modern-table table-sm mb-0">
            <thead>
                        <tr>
                            <th style="width: 5%;">Тип</th>
                            <th style="width: 30%;">Тест</th>
                            <th class="d-none d-md-table-cell" style="width: 12%;">Дата</th>
                            <th class="text-center" style="width: 8%;">Попытка</th>
                            <th class="text-center d-none d-md-table-cell" style="width: 12%;">Результат</th>
                            <th class="text-center" style="width: 10%;">Оценка</th>
                            <th class="d-none d-md-table-cell text-center" style="width: 8%;">Время</th>
                            <th class="text-center" style="width: 15%;">Действия</th>
                        </tr>
            </thead>
            <tbody>
                @foreach (var result in allResults)
                {
                    var duration = result.CompletedAt.HasValue
                        ? (result.CompletedAt.Value - result.StartedAt).ToString(@"mm\:ss")
                        : "-";

                    string testTitle = "Неизвестный тест";
                    int resultId = result.Id;
                    string resultAction = "";
                    string testTypeIcon = "";
                    string testTypeColor = "";

                    if (result is SpellingTestResult spellingResult)
                    {
                        testTitle = spellingResult.SpellingTest?.Title ?? "Неизвестный тест";
                        resultAction = "SpellingResult";
                        testTypeIcon = "spell-check";
                        testTypeColor = "success";
                    }
                    else if (result is PunctuationTestResult punctuationResult)
                    {
                        testTitle = punctuationResult.PunctuationTest?.Title ?? "Неизвестный тест";
                        resultAction = "PunctuationResult";
                        testTypeIcon = "quote-right";
                        testTypeColor = "info";
                    }
                    else if (result is OrthoeopyTestResult orthoeopyResult)
                    {
                        testTitle = orthoeopyResult.OrthoeopyTest?.Title ?? "Неизвестный тест";
                        resultAction = "OrthoeopyResult";
                        testTypeIcon = "volume-up";
                        testTypeColor = "warning";
                    }
                    else if (result is RegularTestResult regularResult)
                    {
                        testTitle = regularResult.RegularTest?.Title ?? "Неизвестный тест";
                        resultAction = "RegularResult";
                        testTypeIcon = "clipboard-check";
                        testTypeColor = "primary";
                    }

                    <tr class="clickable-row" style="cursor: pointer;" data-href="@Url.Action(resultAction, new { id = resultId })">
                        <td>
                            <span class="badge badge-modern-@testTypeColor">
                                <i class="fas fa-@testTypeIcon"></i>
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <small><strong class="text-dark-modern">@testTitle</strong></small>
                                    <div class="d-md-none">
                                        <small class="text-muted-modern">
                                            @result.CompletedAt?.ToString("dd.MM.yy HH:mm")
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="d-none d-md-table-cell">
                            <div>
                                <small class="text-muted-modern">@result.CompletedAt?.ToString("dd.MM.yyyy")</small>
                                <br>
                                <small class="text-muted-modern">
                                    @result.CompletedAt?.ToString("HH:mm")
                                </small>
                            </div>
                        </td>

                        <td class="text-center">
                            <span class="badge badge-modern-info badge-sm">
                                @result.AttemptNumber
                            </span>
                        </td>

                        <td class="text-center d-none d-md-table-cell">
                            <span class="badge @(result.Percentage >= 80 ? "badge-modern-success" : result.Percentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                @result.Percentage.ToString("F1")%
                            </span>
                            <small class="text-muted-modern d-block mt-1">
                                @result.Score/@result.MaxScore
                            </small>
                        </td>

                        <td class="text-center">
                            @if (result.Grade.HasValue)
                            {
                                var gradeColor = result.Grade.Value switch
                                {
                                    5 => "success",
                                    4 => "info",
                                    3 => "warning",
                                    2 => "danger",
                                    _ => "secondary"
                                };
                                <span class="badge badge-modern-@gradeColor" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; min-width: 1.5rem;">
                                    @result.Grade.Value
                                </span>
                                <small class="text-muted d-none d-md-block mt-1">
                                    @result.Percentage.ToString("F1")%
                                </small>
                            }
                            else
                            {
                                <small class="text-muted-modern">—</small>
                            }
                        </td>

                        <td class="text-center d-none d-md-table-cell">
                            <small class="text-muted-modern">@duration</small>
                        </td>

                        <td class="text-center">
                            @if (!string.IsNullOrEmpty(resultAction))
                            {
                                <a asp-action="@resultAction" asp-route-id="@resultId"
                                   class="btn btn-sm btn-modern-outline-info"
                                   onclick="event.stopPropagation();">
                                    <i class="fas fa-eye"></i>
                                    <span class="d-none d-lg-inline">Подробно</span>
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

