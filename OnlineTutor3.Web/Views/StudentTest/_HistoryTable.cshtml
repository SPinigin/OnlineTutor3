@model OnlineTutor3.Web.ViewModels.AssignmentHistoryInfo
@using OnlineTutor3.Domain.Entities

@{
    // Группируем результаты по названию теста
    var testGroups = new Dictionary<string, List<TestResult>>();
    
    // Добавляем результаты по типам тестов
    foreach (var result in Model.SpellingResults.Cast<TestResult>())
    {
        var testTitle = result is SpellingTestResult spellingResult 
            ? (spellingResult.SpellingTest?.Title ?? "Неизвестный тест")
            : "Неизвестный тест";
        
        if (!testGroups.ContainsKey(testTitle))
        {
            testGroups[testTitle] = new List<TestResult>();
        }
        testGroups[testTitle].Add(result);
    }
    
    foreach (var result in Model.PunctuationResults.Cast<TestResult>())
    {
        var testTitle = result is PunctuationTestResult punctuationResult 
            ? (punctuationResult.PunctuationTest?.Title ?? "Неизвестный тест")
            : "Неизвестный тест";
        
        if (!testGroups.ContainsKey(testTitle))
        {
            testGroups[testTitle] = new List<TestResult>();
        }
        testGroups[testTitle].Add(result);
    }
    
    foreach (var result in Model.OrthoeopyResults.Cast<TestResult>())
    {
        var testTitle = result is OrthoeopyTestResult orthoeopyResult 
            ? (orthoeopyResult.OrthoeopyTest?.Title ?? "Неизвестный тест")
            : "Неизвестный тест";
        
        if (!testGroups.ContainsKey(testTitle))
        {
            testGroups[testTitle] = new List<TestResult>();
        }
        testGroups[testTitle].Add(result);
    }
    
    foreach (var result in Model.RegularResults.Cast<TestResult>())
    {
        var testTitle = result is RegularTestResult regularResult 
            ? (regularResult.RegularTest?.Title ?? "Неизвестный тест")
            : "Неизвестный тест";
        
        if (!testGroups.ContainsKey(testTitle))
        {
            testGroups[testTitle] = new List<TestResult>();
        }
        testGroups[testTitle].Add(result);
    }
    
    // Сортируем результаты внутри каждой группы по дате от позднего к раннему
    foreach (var group in testGroups.Values)
    {
        group.Sort((x, y) => 
        {
            var dateX = x.CompletedAt ?? x.StartedAt;
            var dateY = y.CompletedAt ?? y.StartedAt;
            return dateY.CompareTo(dateX); // Обратный порядок - от позднего к раннему
        });
    }
    
    // Сортируем группы по названию теста (natural sort)
    var sortedTestGroups = testGroups.OrderBy(kvp => kvp.Key, StringComparer.OrdinalIgnoreCase).ToList();
}

@if (sortedTestGroups.Any())
{
    <div class="accordion accordion-modern" id="testsAccordion@(Model.Assignment.Id)">
        @{
            int testIndex = 0;
        }
        @foreach (var testGroup in sortedTestGroups)
        {
            var testTitle = testGroup.Key;
            var testResults = testGroup.Value;
            var firstResult = testResults.First();
            var collapseId = $"collapseTest{Model.Assignment.Id}_{testIndex}";
            var headingId = $"headingTest{Model.Assignment.Id}_{testIndex}";
            testIndex++;
            
            // Определяем тип теста и иконку по первому результату
            string testTypeIcon = "";
            string testTypeColor = "";
            if (firstResult is SpellingTestResult)
            {
                testTypeIcon = "spell-check";
                testTypeColor = "success";
            }
            else if (firstResult is PunctuationTestResult)
            {
                testTypeIcon = "quote-right";
                testTypeColor = "info";
            }
            else if (firstResult is OrthoeopyTestResult)
            {
                testTypeIcon = "volume-up";
                testTypeColor = "warning";
            }
            else if (firstResult is RegularTestResult)
            {
                testTypeIcon = "clipboard-check";
                testTypeColor = "primary";
            }
            
            <div class="accordion-item mb-1">
                <h2 class="accordion-header" id="@headingId">
                    <button class="accordion-button collapsed py-2" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#@collapseId" 
                            aria-expanded="false" 
                            aria-controls="@collapseId">
                        <div class="d-flex justify-content-between align-items-center w-100 me-2">
                            <div class="d-flex align-items-center flex-grow-1 flex-wrap gap-1">
                                <span class="badge badge-modern-@testTypeColor me-2">
                                    <i class="fas fa-@testTypeIcon"></i>
                                </span>
                                <div class="me-2">
                                    <strong class="small">@testTitle</strong>
                                </div>
                                <span class="badge bg-primary badge-sm">
                                    <i class="fas fa-clipboard-list"></i> @testResults.Count
                                </span>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="@collapseId" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="@headingId" 
                     data-bs-parent="#testsAccordion@(Model.Assignment.Id)">
                    <div class="accordion-body p-2">
                        <div class="table-responsive">
                            <table class="table modern-table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Дата</th>
                                        <th class="text-center" style="width: 8%;">Попытка</th>
                                        <th class="text-center d-none d-md-table-cell" style="width: 12%;">Результат</th>
                                        <th class="text-center" style="width: 10%;">Оценка</th>
                                        <th class="d-none d-md-table-cell text-center" style="width: 8%;">Время</th>
                                        <th class="text-center" style="width: 15%;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in testResults)
                                    {
                                        var duration = result.CompletedAt.HasValue
                                            ? (result.CompletedAt.Value - result.StartedAt).ToString(@"mm\:ss")
                                            : "-";

                                        int resultId = result.Id;
                                        string resultAction = "";

                                        if (result is SpellingTestResult)
                                        {
                                            resultAction = "SpellingResult";
                                        }
                                        else if (result is PunctuationTestResult)
                                        {
                                            resultAction = "PunctuationResult";
                                        }
                                        else if (result is OrthoeopyTestResult)
                                        {
                                            resultAction = "OrthoeopyResult";
                                        }
                                        else if (result is RegularTestResult)
                                        {
                                            resultAction = "RegularResult";
                                        }

                                        <tr class="clickable-row" style="cursor: pointer;" data-href="@Url.Action(resultAction, new { id = resultId })">
                                            <td>
                                                <div class="d-none d-md-block">
                                                    <small class="text-muted-modern">@result.CompletedAt?.ToString("dd.MM.yyyy")</small>
                                                    <br>
                                                    <small class="text-muted-modern">
                                                        @result.CompletedAt?.ToString("HH:mm")
                                                    </small>
                                                </div>
                                                <div class="d-md-none">
                                                    <small class="text-muted-modern">
                                                        @result.CompletedAt?.ToString("dd.MM.yy HH:mm")
                                                    </small>
                                                </div>
                                            </td>

                                            <td class="text-center">
                                                <span class="badge badge-modern-info badge-sm">
                                                    @result.AttemptNumber
                                                </span>
                                            </td>

                                            <td class="text-center d-none d-md-table-cell">
                                                <span class="badge @(result.Percentage >= 80 ? "badge-modern-success" : result.Percentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                                    @result.Percentage.ToString("F1")%
                                                </span>
                                                <small class="text-muted-modern d-block mt-1">
                                                    @result.Score/@result.MaxScore
                                                </small>
                                            </td>

                                            <td class="text-center">
                                                @if (result.Grade.HasValue)
                                                {
                                                    var gradeColor = result.Grade.Value switch
                                                    {
                                                        5 => "success",
                                                        4 => "info",
                                                        3 => "warning",
                                                        2 => "danger",
                                                        _ => "secondary"
                                                    };
                                                    <span class="badge badge-modern-@gradeColor" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; min-width: 1.5rem;">
                                                        @result.Grade.Value
                                                    </span>
                                                    <small class="text-muted d-none d-md-block mt-1">
                                                        @result.Percentage.ToString("F1")%
                                                    </small>
                                                    <div class="d-md-none mt-1">
                                                        <span class="badge @(result.Percentage >= 80 ? "badge-modern-success" : result.Percentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                                            @result.Percentage.ToString("F1")%
                                                        </span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div>
                                                        <span class="badge @(result.Percentage >= 80 ? "badge-modern-success" : result.Percentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                                            @result.Percentage.ToString("F1")%
                                                        </span>
                                                    </div>
                                                }
                                            </td>

                                            <td class="text-center d-none d-md-table-cell">
                                                <small class="text-muted-modern">@duration</small>
                                            </td>

                                            <td class="text-center">
                                                @if (!string.IsNullOrEmpty(resultAction))
                                                {
                                                    <a asp-action="@resultAction" asp-route-id="@resultId"
                                                       class="btn btn-sm btn-modern-outline-info"
                                                       onclick="event.stopPropagation();">
                                                        <i class="fas fa-eye"></i>
                                                        <span class="d-none d-lg-inline">Подробно</span>
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
