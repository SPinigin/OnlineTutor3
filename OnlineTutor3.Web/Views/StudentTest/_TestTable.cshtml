@model List<OnlineTutor3.Web.ViewModels.AvailableTestInfo>
@{
    var testType = ViewData["TestType"] as string ?? "Regular";
}

@if (Model.Any())
{
    <div class="table-responsive">
        <table class="table modern-table table-sm mb-0">
            <thead>
                <tr>
                    <th style="width: 30%;">Название</th>
                    <th class="d-none d-md-table-cell" style="width: 25%;">Описание</th>
                    <th class="text-center" style="width: 8%;">
                        <i class="fas fa-question-circle d-none d-md-inline"></i>
                        <span class="d-md-none">Вопр.</span>
                        <span class="d-none d-md-inline">Вопросы</span>
                    </th>
                    <th class="d-none d-md-table-cell text-center" style="width: 8%;">
                        <i class="fas fa-clock"></i> Время
                    </th>
                    <th class="text-center" style="width: 10%;">
                        <span class="d-none d-md-inline">Попытки</span>
                        <span class="d-md-none">Поп.</span>
                    </th>
                    <th class="d-none d-md-table-cell text-center" style="width: 10%;">Лучший результат</th>
                    <th class="text-center" style="width: 15%;">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var test in Model)
                {
                    <tr class="test-row" data-test-title="@test.Title.ToLower()">
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <small><strong class="text-dark-modern">@test.Title</strong></small>
                                    @if (test.BestPercentage.HasValue)
                                    {
                                        <small class="d-md-none">
                                            <span class="badge @(test.BestPercentage >= 80 ? "badge-modern-success" : test.BestPercentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                                @test.BestPercentage.Value.ToString("F1")%
                                            </span>
                                        </small>
                                    }
                                </div>
                            </div>
                        </td>

                        <td class="d-none d-md-table-cell">
                            @if (!string.IsNullOrEmpty(test.Description))
                            {
                                <small class="text-muted-modern">@test.Description</small>
                            }
                            else
                            {
                                <small class="text-muted-modern">—</small>
                            }
                        </td>

                        <td class="text-center">
                            <small class="text-muted-modern">@test.QuestionsCount</small>
                        </td>

                        <td class="text-center d-none d-md-table-cell">
                            <small class="text-muted-modern">@test.TimeLimit мин</small>
                        </td>

                        <td class="text-center">
                            <span class="badge @(test.AttemptsUsed >= test.MaxAttempts ? "badge-modern-danger" : "badge-modern-warning") badge-sm">
                                @test.AttemptsUsed/@test.MaxAttempts
                            </span>
                        </td>

                        <td class="text-center d-none d-md-table-cell">
                            @if (test.BestPercentage.HasValue)
                            {
                                <span class="badge @(test.BestPercentage >= 80 ? "badge-modern-success" : test.BestPercentage >= 60 ? "badge-modern-warning" : "badge-modern-danger") badge-sm">
                                    @test.BestPercentage.Value.ToString("F1")%
                                </span>
                            }
                            else
                            {
                                <small class="text-muted-modern">—</small>
                            }
                        </td>

                        <td class="text-center">
                            @if (test.Status == TestStatus.Ongoing && test.OngoingTestResultId.HasValue)
                            {
                                @if (testType == "Spelling")
                                {
                                    <a asp-action="TakeSpelling" asp-route-id="@test.OngoingTestResultId.Value" 
                                       class="btn btn-sm btn-modern-outline-warning">
                                        <i class="fas fa-play"></i>
                                        <span class="d-none d-lg-inline ms-1">Продолжить</span>
                                    </a>
                                }
                                else if (testType == "Punctuation")
                                {
                                    <a asp-action="TakePunctuation" asp-route-id="@test.OngoingTestResultId.Value" 
                                       class="btn btn-sm btn-modern-outline-warning">
                                        <i class="fas fa-play"></i>
                                        <span class="d-none d-lg-inline ms-1">Продолжить</span>
                                    </a>
                                }
                                else if (testType == "Orthoeopy")
                                {
                                    <a asp-action="TakeOrthoeopy" asp-route-id="@test.OngoingTestResultId.Value" 
                                       class="btn btn-sm btn-modern-outline-warning">
                                        <i class="fas fa-play"></i>
                                        <span class="d-none d-lg-inline ms-1">Продолжить</span>
                                    </a>
                                }
                                else if (testType == "Regular")
                                {
                                    <a asp-action="TakeRegular" asp-route-id="@test.OngoingTestResultId.Value" 
                                       class="btn btn-sm btn-modern-outline-warning">
                                        <i class="fas fa-play"></i>
                                        <span class="d-none d-lg-inline ms-1">Продолжить</span>
                                    </a>
                                }
                            }
                            else if (test.Status == TestStatus.CanStart)
                            {
                                <button type="button" class="btn btn-sm btn-modern-success"
                                        onclick="confirmStartTest(@test.Id, '@test.Title.Replace("'", "\\'")', @test.TimeLimit, '@testType.ToLower()')">
                                    <i class="fas fa-play"></i>
                                    <span class="d-none d-lg-inline ms-1">Начать</span>
                                </button>
                            }
                            else if (test.Status == TestStatus.Exhausted)
                            {
                                <button type="button" class="btn btn-sm btn-modern-outline-secondary" disabled>
                                    <i class="fas fa-ban"></i>
                                    <span class="d-none d-lg-inline ms-1">Исчерпано</span>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

