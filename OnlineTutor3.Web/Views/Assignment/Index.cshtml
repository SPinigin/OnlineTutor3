@model IEnumerable<OnlineTutor3.Domain.Entities.Assignment>
@{
    ViewData["Title"] = "Управление заданиями";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item active">Управление заданиями</li>
            </ol>
        </nav>
    </div>
    <div>
        <a asp-action="Create" class="btn btn-success">
            <i class="fas fa-plus"></i> Создать задание
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="text-center py-5">
        <i class="fas fa-tasks text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">У вас пока нет заданий</h4>
        <p class="text-muted">Создайте свое первое задание для начала работы с тестами</p>
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Создать первое задание
        </a>
    </div>
}
else
{
    <div class="row mb-3 align-items-center">
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <h6 class="mb-0">
                <i class="fas fa-tasks"></i> 
                <span>Всего заданий: @Model.Count()</span>
            </h6>
        </div>
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" 
                       id="searchInput" 
                       class="form-control" 
                       placeholder="Поиск по названию..."
                       autocomplete="off">
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white">
                    <i class="fas fa-filter text-muted"></i>
                </span>
                <select id="subjectFilter" class="form-select">
                    <option value="">Все предметы</option>
                @if (ViewBag.Subjects != null)
                {
                    @foreach (var subject in (SelectList)ViewBag.Subjects)
                    {
                        <option value="@subject.Value">@subject.Text</option>
                    }
                }
                </select>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 30%;">Название</th>
                    <th style="width: 25%;">Предмет</th>
                    <th style="width: 20%;">Срок выполнения</th>
                    <th style="width: 10%;" class="text-center">Статус</th>
                    <th style="width: 15%;" class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody id="assignmentsTableBody">
                @foreach (var assignment in Model)
                {
                    <tr data-assignment-id="@assignment.Id" data-subject-id="@assignment.SubjectId">
                        <td>
                            <strong>@assignment.Title</strong>
                            @if (!string.IsNullOrEmpty(assignment.Description))
                            {
                                <br>
                                <small class="text-muted">@(assignment.Description.Length > 50 ? assignment.Description.Substring(0, 50) + "..." : assignment.Description)</small>
                            }
                        </td>
                        <td>
                            @{
                                var subjectsDict = ViewBag.SubjectsDict as Dictionary<int, string>;
                                var subjectName = subjectsDict != null && subjectsDict.ContainsKey(assignment.SubjectId) 
                                    ? subjectsDict[assignment.SubjectId] 
                                    : $"Предмет #{assignment.SubjectId}";
                            }
                            <span class="badge bg-info">@subjectName</span>
                        </td>
                        <td>
                            @if (assignment.DueDate.HasValue)
                            {
                                <span class="@(assignment.DueDate.Value < DateTime.Now ? "text-danger" : "")">
                                    @assignment.DueDate.Value.ToString("dd.MM.yyyy HH:mm")
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">Не указан</span>
                            }
                        </td>
                        <td class="text-center">
                            @if (assignment.IsActive)
                            {
                                <span class="badge bg-success">Активно</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Неактивно</span>
                            }
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a asp-action="Details" asp-route-id="@assignment.Id" class="btn btn-outline-info" title="Подробнее">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@assignment.Id" class="btn btn-outline-primary" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@assignment.Id" class="btn btn-outline-danger" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Поиск
            $('#searchInput').on('keyup', function() {
                var searchText = $(this).val().toLowerCase();
                $('#assignmentsTableBody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchText) > -1);
                });
            });

            // Фильтр по предмету
            $('#subjectFilter').on('change', function() {
                var subjectId = $(this).val();
                if (subjectId === '') {
                    $('#assignmentsTableBody tr').show();
                } else {
                    $('#assignmentsTableBody tr').hide();
                    $('#assignmentsTableBody tr[data-subject-id="' + subjectId + '"]').show();
                }
            });
        });
    </script>
}

