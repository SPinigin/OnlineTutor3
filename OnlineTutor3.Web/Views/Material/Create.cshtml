@model OnlineTutor3.Web.ViewModels.CreateMaterialViewModel
@{
    ViewData["Title"] = "Загрузка материала";
}

<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow modern-card">
            <div class="card-header auth-card-header py-2">
                <h5 class="mb-0">
                    <i class="fas fa-upload"></i> Загрузка учебного материала
                </h5>
            </div>
            <div class="card-body auth-card-body py-3">
                <div class="alert alert-info py-2 mb-2 small">
                    <i class="fas fa-info-circle"></i> <strong>Поддерживаемые форматы:</strong> PDF, Word, PowerPoint, Excel, изображения, аудио, видео
                </div>

                <form asp-action="Create" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div asp-validation-summary="All" class="text-danger mb-2 small"></div>

                    <div class="mb-2">
                        <label asp-for="Title" class="form-label form-label-modern small mb-1">
                            Название материала <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Title" class="form-control form-control-sm form-control-modern" placeholder="Например: Правила орфографии" />
                        <span asp-validation-for="Title" class="text-danger small"></span>
                    </div>

                    <div class="mb-2">
                        <label asp-for="Description" class="form-label form-label-modern small mb-1">
                            Описание
                        </label>
                        <textarea asp-for="Description" class="form-control form-control-sm form-control-modern" rows="2"
                                  placeholder="Краткое описание содержания материала..."></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                    </div>

                    <div class="mb-2">
                        <label asp-for="File" class="form-label form-label-modern small mb-1">
                            Выберите файл <span class="text-danger">*</span>
                        </label>
                        <input asp-for="File" class="form-control form-control-sm form-control-modern" type="file" id="fileInput"
                               accept=".pdf,.doc,.docx,.txt,.rtf,.ppt,.pptx,.xls,.xlsx,.csv,.jpg,.jpeg,.png,.gif,.bmp,.mp3,.wav,.m4a,.mp4,.avi,.mov,.wmv" />
                        <span asp-validation-for="File" class="text-danger small"></span>

                        <div id="fileInfo" class="mt-2" style="display: none;">
                            <div class="small text-dark-modern">
                                <i id="fileIcon" class="fas fa-file text-muted-modern me-1"></i>
                                <span id="fileName"></span> (<span id="fileSize"></span>)
                            </div>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label asp-for="AssignmentId" class="form-label form-label-modern small mb-1">
                            Задание <span class="text-danger">*</span>
                        </label>
                        <select asp-for="AssignmentId" asp-items="@ViewBag.Assignments" class="form-select form-select-sm form-control-modern">
                            <option value="">Не выбрано</option>
                        </select>
                        <span asp-validation-for="AssignmentId" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input asp-for="IsActive" class="form-check-input" />
                            <label asp-for="IsActive" class="form-check-label text-dark-modern small">
                                Материал активен
                            </label>
                        </div>
                        <div class="form-text text-muted-modern small">
                            Неактивные материалы скрыты от учеников
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <a asp-action="Index" class="btn btn-modern-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Отмена</span>
                        </a>
                        <button type="submit" class="btn btn-modern-success btn-sm" id="submitBtn">
                            <i class="fas fa-upload"></i> <span class="d-none d-sm-inline">Загрузить</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileIcon = document.getElementById('fileIcon');
            const titleInput = document.getElementById('Title');

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    updateFileIcon(file.name);
                    if (!titleInput.value.trim()) {
                        titleInput.value = file.name.replace(/\.[^/.]+$/, "");
                    }
                    fileInfo.style.display = 'block';
                } else {
                    fileInfo.style.display = 'none';
                }
            });

            function formatFileSize(bytes) {
                const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];
                if (bytes === 0) return '0 Б';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
            }

            function updateFileIcon(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file text-muted';
                switch (extension) {
                    case 'pdf': iconClass = 'fas fa-file-pdf text-danger'; break;
                    case 'doc': case 'docx': iconClass = 'fas fa-file-word text-primary'; break;
                    case 'xls': case 'xlsx': iconClass = 'fas fa-file-excel text-success'; break;
                    case 'ppt': case 'pptx': iconClass = 'fas fa-file-powerpoint text-warning'; break;
                    case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': iconClass = 'fas fa-file-image text-info'; break;
                    case 'mp3': case 'wav': case 'm4a': iconClass = 'fas fa-file-audio text-success'; break;
                    case 'mp4': case 'avi': case 'mov': case 'wmv': iconClass = 'fas fa-file-video text-primary'; break;
                }
                fileIcon.className = iconClass + ' me-1';
            }

            document.getElementById('uploadForm').addEventListener('submit', function() {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="d-none d-sm-inline">Загружается...</span>';
            });
        });
    </script>
}
